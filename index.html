<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Order Cafe - 17 b√†n</title>
  <style>
    :root{
      --bg:#faf6ef; --accent:#d2691e; --muted:#6b6b6b;
      --card:#fff; --success:#2b8a3e; --info:#1e90ff; --danger:#d9534f;
      --note-bg:#fffaf0;
    }
    *{box-sizing:border-box;font-family:Inter,Segoe UI,Helvetica,Arial;}
    body{margin:0;background:linear-gradient(180deg,#fbf7f3 0%,#f3eee8 100%);color:#222}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;border-bottom:1px solid #eee;background:var(--card)}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:56px;height:56px;border-radius:8px;background:linear-gradient(135deg,#ffcf9a,#f6b27f);display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff}
    h1{font-size:18px;margin:0}
    .top-stats{font-size:14px;color:var(--muted)}
    .container{display:grid;grid-template-columns:320px 1fr 420px;gap:16px;padding:16px;align-items:start}
    /* left menu */
    .menu-card{background:var(--card);padding:12px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.04);height:calc(100vh - 120px);overflow:auto}
    .search{display:flex;gap:8px;margin-bottom:8px}
    .search input{flex:1;padding:8px;border:1px solid #eee;border-radius:6px}
    .cat-list{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
    .cat-item{padding:6px 8px;border-radius:6px;background:#fff;border:1px solid #eee;cursor:pointer}
    .cat-item.active{background:var(--accent);color:#fff;border-color:transparent}
    .item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:6px;margin-bottom:6px;background:#fff;border:1px solid #f0f0f0}
    .item .meta{display:flex;flex-direction:column}
    .item button{padding:6px 8px;border-radius:6px;border:0;background:var(--accent);color:#fff;cursor:pointer}
    /* center tables */
    .tables{background:var(--card);padding:12px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.04)}
    .tables-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
    .table-btn{padding:12px;border-radius:8px;background:#fff;border:1px solid #eee;cursor:pointer;text-align:center;position:relative;min-height:64px}
    .table-btn.selected{background:linear-gradient(180deg,#ffefe0,#fff);border:1px solid #f0a86b;box-shadow:0 6px 18px rgba(240,150,80,0.08)}
    .table-status{font-size:12px;color:var(--muted);margin-top:6px}
    .note-badge{position:absolute;right:8px;top:8px;background:#fffae6;border:1px solid #f0a86b;color:#b36b00;padding:4px 6px;border-radius:6px;font-size:12px;display:flex;align-items:center;gap:6px}
    /* right order panel */
    .order-card{background:var(--card);padding:12px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.04);height:calc(100vh - 120px);overflow:auto}
    .order-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .order-list{margin-top:8px}
    .order-row{display:flex;gap:8px;align-items:center;padding:8px;border-radius:6px;background:#fbfbfb;border:1px solid #f0f0f0;margin-bottom:6px}
    .order-row .qty{width:34px;height:34px;border-radius:6px;background:#fff;border:1px solid #eee;display:flex;align-items:center;justify-content:center;font-weight:600}
    .order-row .name{flex:1}
    .order-row .price{width:120px;text-align:right;font-weight:700}
    .order-actions{display:flex;gap:8px;margin-top:8px}
    .btn{padding:8px 10px;border-radius:6px;border:0;cursor:pointer}
    .btn.ghost{background:#fff;border:1px solid #ddd}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.danger{background:var(--danger);color:#fff}
    .small{font-size:13px;color:var(--muted)}
    .footer{margin-top:12px;border-top:1px dashed #eee;padding-top:8px;display:flex;justify-content:space-between;align-items:center}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:2200}
    .modal .box{background:#fff;padding:16px;border-radius:8px;width:560px;max-width:95%}
    label{display:block;font-size:13px;margin-top:8px}
    input[type="text"],input[type="number"],select,textarea{width:100%;padding:8px;border:1px solid #eee;border-radius:6px}
    textarea{min-height:80px}
    .history-item{padding:8px;border-radius:6px;background:#fff;border:1px solid #f0f0f0;margin-bottom:6px}
    .menu-image{width:100%;border-radius:6px;margin-bottom:8px}
    /* note box styling */
    .note-box{background:var(--note-bg);border:1px solid #fde3c9;padding:12px;border-radius:8px;box-shadow:0 6px 18px rgba(240,150,80,0.06);display:flex;gap:12px;align-items:flex-start;width:100%}
    .note-box textarea{flex:1;min-height:120px;border-radius:8px;padding:10px;font-size:14px;border:1px solid #ffe6cc;background:transparent;resize:vertical}
    .note-controls{display:flex;flex-direction:column;gap:8px;align-items:flex-end}
    .note-meta{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
    .note-saved{font-size:13px;padding:6px 8px;border-radius:16px;background:rgba(43,138,62,0.12);color:var(--success);display:inline-flex;align-items:center;gap:6px}
    .note-char{font-size:12px;color:var(--muted)}
    /* banner container */
    .banner-container{position:fixed;left:50%;transform:translateX(-50%);top:72px;z-index:2100;display:flex;flex-direction:column;gap:8px;width:clamp(320px,56%,820px);pointer-events:none}
    .banner{pointer-events:auto;padding:12px 14px;border-radius:8px;color:#fff;box-shadow:0 6px 18px rgba(0,0,0,0.12);display:flex;justify-content:space-between;align-items:center;gap:12px}
    .banner .msg{flex:1}
    .banner .close-btn{background:transparent;border:0;color:rgba(255,255,255,0.9);cursor:pointer;font-weight:700;padding:6px}
    .banner.success{background:linear-gradient(90deg,var(--success),#2f9e4b)}
    .banner.info{background:linear-gradient(90deg,var(--info),#2f86ff)}
    .banner.error{background:linear-gradient(90deg,var(--danger),#d4433f)}
    /* responsive */
    @media (max-width:1100px){.container{grid-template-columns:1fr;} .banner-container{top:64px;width:92%;}}
  </style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo">CF</div>
    <div>
      <h1>App Oder</h1>
      <div class="top-stats small">L∆∞u tr·∫°ng th√°i: <strong id="storageState">ON</strong></div>
    </div>
  </div>
  <div class="top-stats">
    T·ªïng doanh thu: <strong id="totalRevenue">0</strong> &nbsp; ‚Ä¢ &nbsp;
    B√†n ƒëang ch·ªçn: <strong id="currentTableLabel">‚Äî</strong>
  </div>
</header>

<!-- banner container (for on-screen notifications) -->
<div class="banner-container" id="bannerContainer" aria-live="polite"></div>

<div class="container">
  <!-- left: menu -->
  <div class="menu-card">
    <div class="search">
      <input id="searchMenu" placeholder="T√¨m m√≥n..." />
      <button class="btn ghost" id="openAddItem">+ Th√™m m√≥n</button>
    </div>
    <div class="cat-list" id="catList"></div>
    <div id="menuItems"></div>
  </div>

  <!-- center: tables -->
  <div class="tables">
    <h3 style="margin:0 0 8px 0">S∆° ƒë·ªì b√†n (17 b√†n)</h3>
    <div class="tables-grid" id="tablesGrid"></div>
    <div style="margin-top:12px" class="small">Ghi ch√∫: Gi√° hi·ªÉn th·ªã l√† **VND** (v√≠ d·ª• 25 => <strong>25.000 ƒë</strong>)</div>
  </div>

  <!-- right: order / details -->
  <div class="order-card">
    <div class="order-header">
      <div>
        <h3 style="margin:0">Chi ti·∫øt b√†n</h3>
        <div class="small" id="tableInfo">Ch·ªçn b√†n ƒë·ªÉ b·∫Øt ƒë·∫ßu order</div>
      </div>
      <div>
        <button class="btn ghost" id="toggleStorage">T·∫Øt l∆∞u</button>
        <button class="btn ghost" id="openManageMenu">Qu·∫£n l√Ω menu</button>
      </div>
    </div>

    <div id="orderPanel" style="display:none">
      <div class="small">Order hi·ªán t·∫°i</div>
      <div class="order-list" id="orderList"></div>

      <div class="order-actions">
        <button class="btn primary" id="checkoutBtn">Thanh to√°n (Checkout)</button>
        <button class="btn ghost" id="clearOrderBtn">X√≥a order hi·ªán t·∫°i</button>
        <button class="btn ghost" id="viewHistoryBtn">L·ªãch s·ª≠ b√†n</button>
      </div>

      <div class="footer">
        <div>
          T·ªïng ƒë∆°n: <strong id="tableTotal">0</strong>
        </div>
        <div>
          <button class="btn ghost" id="addCustomToTable">+ Th√™m m√≥n tu·ª≥ √Ω</button>
        </div>
      </div>

      <hr />
      <h4 style="margin:10px 0 6px 0">Ghi ch√∫ b√†n</h4>

      <!-- improved note box -->
      <div class="note-box">
        <textarea id="tableNote" placeholder="Nh·∫≠p ghi ch√∫ cho b√†n (v√≠ d·ª•: √≠t ƒë∆∞·ªùng, kh√¥ng ƒë√°, ƒë·∫∑t tr∆∞·ªõc ...)" maxlength="500"></textarea>
        <div class="note-controls">
          <div class="note-meta">
            <div id="noteSavedIndicator" style="display:none" class="note-saved">‚úì ƒê√£ l∆∞u</div>
            <div id="noteCharCount" class="note-char">0 k√Ω t·ª±</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button class="btn primary" id="saveNoteBtn">L∆∞u ghi ch√∫</button>
            <button class="btn ghost" id="clearNoteBtn">X√≥a ghi ch√∫</button>
          </div>
        </div>
      </div>

      <hr />
      <h4 style="margin:10px 0 6px 0">L·ªãch s·ª≠ (g·∫ßn nh·∫•t)</h4>
      <div id="recentHistory"></div>
    </div>

    <div id="noTableSelected" style="color:var(--muted);">Ch∆∞a c√≥ b√†n n√†o ƒë∆∞·ª£c ch·ªçn.</div>

  </div>
</div>

<!-- modal templates -->
<div id="modalRoot"></div>

<script>
/*
  File: Single-file order app (updated)
  - UI: improved note box
  - Notifications: on-screen banners (replaces alert(...) calls)
*/

// ======== D·ªØ li·ªáu kh·ªüi t·∫°o menu (ƒë√£ chuy·ªÉn t·ª´ ·∫£nh) ========
function genId(){ return 'id_'+Math.random().toString(36).slice(2,9); }

const DEFAULT_MENU = [
  // (same as before)...
  {id:genId(),name:'C√† Ph√™ ƒê√° (M)',category:'C√† Ph√™ Nguy√™n Ch·∫•t',price:25},
  {id:genId(),name:'C√† Ph√™ ƒê√° (L)',category:'C√† Ph√™ Nguy√™n Ch·∫•t',price:33},
  {id:genId(),name:'C√† Ph√™ S·ªØa (M)',category:'C√† Ph√™ Nguy√™n Ch·∫•t',price:27},
  {id:genId(),name:'C√† Ph√™ S·ªØa (L)',category:'C√† Ph√™ Nguy√™n Ch·∫•t',price:35},
  {id:genId(),name:'B·∫°c X·ªâu (M)',category:'C√† Ph√™ Nguy√™n Ch·∫•t',price:30},
  {id:genId(),name:'B·∫°c X·ªâu (L)',category:'C√† Ph√™ Nguy√™n Ch·∫•t',price:38},
  {id:genId(),name:'C√† Ph√™ Mu·ªëi (M)',category:'C√† Ph√™ Nguy√™n Ch·∫•t',price:32},
  {id:genId(),name:'C√† Ph√™ Mu·ªëi (L)',category:'C√† Ph√™ Nguy√™n Ch·∫•t',price:40},
  {id:genId(),name:'S·ªØa T∆∞∆°i C√† Ph√™ (M)',category:'C√† Ph√™ Nguy√™n Ch·∫•t',price:32},
  {id:genId(),name:'S·ªØa T∆∞∆°i C√† Ph√™ (L)',category:'C√† Ph√™ Nguy√™n Ch·∫•t',price:40},
  {id:genId(),name:'Cacao S·ªØa (M)',category:'C√† Ph√™ Nguy√™n Ch·∫•t',price:35},
  {id:genId(),name:'Cacao S·ªØa (L)',category:'C√† Ph√™ Nguy√™n Ch·∫•t',price:40},
  {id:genId(),name:'Yaourt ƒê√°',category:'Yaourt',price:30},
  {id:genId(),name:'Yaourt Vi·ªát Qu·∫•t',category:'Yaourt',price:35},
  {id:genId(),name:'Yaourt Chanh D√¢y',category:'Yaourt',price:35},
  {id:genId(),name:'Yaourt C√† Ph√™',category:'Yaourt',price:35},
  {id:genId(),name:'Soda Chanh',category:'Soda',price:35},
  {id:genId(),name:'Soda Vi·ªát Qu·∫•t',category:'Soda',price:35},
  {id:genId(),name:'Matcha S·ªØa',category:'Matcha',price:35},
  {id:genId(),name:'Matcha Tr√† S·ªØa',category:'Matcha',price:35},
  {id:genId(),name:'Matcha ƒê·∫≠u ƒê·ªè',category:'Matcha',price:35},
  {id:genId(),name:'Tr√† Lipton',category:'Tr√†',price:30},
  {id:genId(),name:'Tr√† G·ª´ng',category:'Tr√†',price:30},
  {id:genId(),name:'Tr√† G·ª´ng M·∫≠t Ong',category:'Tr√†',price:35},
  {id:genId(),name:'Tr√† Chanh Truy·ªÅn Th·ªëng',category:'Tr√†',price:30},
  {id:genId(),name:'Tr√† Chanh Ho√†ng Kim',category:'Tr√†',price:35},
  {id:genId(),name:'Tr√† ƒê√†o',category:'Tr√†',price:35},
  {id:genId(),name:'Tr√† ƒê√†o S·ªØa',category:'Tr√†',price:38},
  {id:genId(),name:'Tr√† V·∫£i',category:'Tr√†',price:35},
  {id:genId(),name:'Tr√† D√¢u',category:'Tr√†',price:35},
  {id:genId(),name:'Tr√† ·ªîi',category:'Tr√†',price:35},
  {id:genId(),name:'Tr√† Xanh D∆∞a L∆∞·ªõi',category:'Tr√†',price:35},
  {id:genId(),name:'Tr√† Kiwi D∆∞a L∆∞·ªõi',category:'Tr√†',price:35},
  {id:genId(),name:'Tr√† Kiwi T√°o Xanh',category:'Tr√†',price:35},
  {id:genId(),name:'N∆∞·ªõc Chanh ƒê√° - N√≥ng',category:'N∆∞·ªõc Tr√°i C√¢y',price:30},
  {id:genId(),name:'N∆∞·ªõc Chanh M·∫≠t Ong',category:'N∆∞·ªõc Tr√°i C√¢y',price:35},
  {id:genId(),name:'N∆∞·ªõc Chanh Mu·ªëi',category:'N∆∞·ªõc Tr√°i C√¢y',price:30},
  {id:genId(),name:'N∆∞·ªõc Cam V·∫Øt',category:'N∆∞·ªõc Tr√°i C√¢y',price:32},
  {id:genId(),name:'N∆∞·ªõc Cam V·∫Øt M·∫≠t Ong',category:'N∆∞·ªõc Tr√°i C√¢y',price:35},
  {id:genId(),name:'N∆∞·ªõc Chanh D√¢y',category:'N∆∞·ªõc Tr√°i C√¢y',price:30},
  {id:genId(),name:'N∆∞·ªõc √âp ·ªîi',category:'N∆∞·ªõc √âp',price:32},
  {id:genId(),name:'N∆∞·ªõc √âp Th∆°m',category:'N∆∞·ªõc √âp',price:32},
  {id:genId(),name:'N∆∞·ªõc √âp D∆∞a H·∫•u',category:'N∆∞·ªõc √âp',price:32},
  {id:genId(),name:'N∆∞·ªõc √âp C√† R·ªët',category:'N∆∞·ªõc √âp',price:32},
  {id:genId(),name:'N∆∞·ªõc √âp T√°o',category:'N∆∞·ªõc √âp',price:35},
  {id:genId(),name:'N∆∞·ªõc √âp Mix 2 Lo·∫°i',category:'N∆∞·ªõc √âp',price:35},
  {id:genId(),name:'N∆∞·ªõc Ng·ªçt C√°c Lo·∫°i',category:'N∆∞·ªõc Ng·ªçt',price:25},
  {id:genId(),name:'B√≤ H√∫c Th√°i',category:'N∆∞·ªõc Ng·ªçt',price:27},
  {id:genId(),name:'N∆∞·ªõc Su·ªëi',category:'N∆∞·ªõc Ng·ªçt',price:20}
];

// ======= Utils & storage keys =======
const STORAGE_KEY = 'cafe_order_app_v1';
function saveState(state){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){} }
function loadState(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)); }catch(e){return null} }

// Format: price is stored as number in "ngh√¨n" (e.g., 25 = 25.000 VND).
// fmtVND converts that to full VND with thousands separator and " ƒë".
function fmtVND(n){
  const num = Number(n) || 0;
  const vnd = Math.round(num * 1000); // convert ngh√¨n -> VND
  return vnd.toLocaleString('vi-VN') + ' ƒë';
}
function fmtNumber(n){ return Number(n).toLocaleString('vi-VN'); }

// ======= App state =======
let state = loadState() || {
  menu: DEFAULT_MENU.slice(),
  categories: [],
  tables: [], // will be 17 tables
  totalRevenue: 0, // stored in "ngh√¨n"
  storageEnabled: true
};

function rebuildCategories(){
  const cats = Array.from(new Set(state.menu.map(i=>i.category)));
  state.categories = cats;
}

// init tables if empty
if(!state.tables || state.tables.length !== 17){
  state.tables = Array.from({length:17},(_,i)=>({
    id: i+1, // s·ªë b√†n
    currentOrder: [], // m·ªói item: {menuId,name,price,qty}
    history: [], // m·ªói entry: {timestamp, items, total}
    note: '' // ghi ch√∫ cho b√†n (string)
  }));
}

// ensure each table has note property (migrate older state)
state.tables.forEach(t=>{ if(typeof t.note === 'undefined') t.note = ''; });

// ensure categories
rebuildCategories();
saveState(state);

// ======= DOM refs =======
const catListEl = document.getElementById('catList');
const menuItemsEl = document.getElementById('menuItems');
const tablesGridEl = document.getElementById('tablesGrid');
const orderPanel = document.getElementById('orderPanel');
const noTableSelected = document.getElementById('noTableSelected');
const tableInfoEl = document.getElementById('tableInfo');
const currentTableLabel = document.getElementById('currentTableLabel');
const totalRevenueEl = document.getElementById('totalRevenue');
const storageStateEl = document.getElementById('storageState');
const toggleStorageBtn = document.getElementById('toggleStorage');
const searchInput = document.getElementById('searchMenu');
const modalRoot = document.getElementById('modalRoot');
const openAddItemBtn = document.getElementById('openAddItem');
const openManageMenuBtn = document.getElementById('openManageMenu');
const orderListEl = document.getElementById('orderList');
const tableTotalEl = document.getElementById('tableTotal');
const checkoutBtn = document.getElementById('checkoutBtn');
const clearOrderBtn = document.getElementById('clearOrderBtn');
const viewHistoryBtn = document.getElementById('viewHistoryBtn');
const recentHistoryEl = document.getElementById('recentHistory');
const addCustomToTableBtn = document.getElementById('addCustomToTable');
const tableNoteEl = document.getElementById('tableNote');
const saveNoteBtn = document.getElementById('saveNoteBtn');
const clearNoteBtn = document.getElementById('clearNoteBtn');
const noteSavedIndicator = document.getElementById('noteSavedIndicator');
const noteCharCount = document.getElementById('noteCharCount');
const bannerContainer = document.getElementById('bannerContainer');

// selected table id
let selectedTableId = null;
let activeCategory = null;
let menuFilter = '';

// ======= Banner system (on-screen notifications) =======
let bannerIdCounter = 0;
function showBanner(type, message, opts = {}) {
  // type: 'success' | 'info' | 'error'
  const id = 'bn_' + (++bannerIdCounter);
  const el = document.createElement('div');
  el.className = 'banner ' + (type||'info');
  el.id = id;
  el.innerHTML = `<div class="msg">${message}</div><button class="close-btn" aria-label="ƒê√≥ng">‚úï</button>`;
  const closeBtn = el.querySelector('.close-btn');
  closeBtn.onclick = ()=> { if(el.parentNode) el.parentNode.removeChild(el); };
  bannerContainer.appendChild(el);
  const timeout = opts.timeout || 4200;
  if(timeout > 0){
    setTimeout(()=>{ if(el.parentNode) el.parentNode.removeChild(el); }, timeout);
  }
  return id;
}

// helper small wrappers
function info(msg, opts){ return showBanner('info', msg, opts); }
function success(msg, opts){ return showBanner('success', msg, opts); }
function error(msg, opts){ return showBanner('error', msg, opts); }

// ======= Render functions =======
function renderCategories(){
  rebuildCategories();
  catListEl.innerHTML = '';
  const allBtn = document.createElement('div');
  allBtn.className = 'cat-item' + (activeCategory===null ? ' active':'');
  allBtn.textContent = 'T·∫•t c·∫£';
  allBtn.onclick = ()=>{ activeCategory = null; renderMenu(); renderCategories(); };
  catListEl.appendChild(allBtn);
  state.categories.forEach(cat=>{
    const d = document.createElement('div');
    d.className = 'cat-item' + (activeCategory===cat ? ' active' : '');
    d.textContent = cat;
    d.onclick = ()=>{ activeCategory = cat; renderMenu(); renderCategories(); };
    catListEl.appendChild(d);
  });
}

function renderMenu(){
  const q = (menuFilter||'').trim().toLowerCase();
  const items = state.menu.filter(it=>{
    if(activeCategory && it.category !== activeCategory) return false;
    if(q && !(`${it.name} ${it.category}`.toLowerCase().includes(q))) return false;
    return true;
  });
  menuItemsEl.innerHTML = '';
  items.forEach(it=>{
    const node = document.createElement('div');
    node.className = 'item';
    node.innerHTML = `<div class="meta"><div style="font-weight:600">${it.name}</div><div class="small">${it.category}</div></div>
                      <div style="text-align:right"><div style="font-weight:700">${fmtVND(it.price)}</div><div style="margin-top:6px"><button class="addBtn">+ Order</button></div></div>`;
    node.querySelector('.addBtn').onclick = ()=>{
      if(!selectedTableId){ info('Vui l√≤ng ch·ªçn b√†n tr∆∞·ªõc khi order.'); return; }
      const qtyPrompt = prompt('S·ªë l∆∞·ª£ng?', '1');
      if(qtyPrompt === null) return; // user cancelled
      const qty = parseInt(qtyPrompt) || 1;
      addItemToTable(selectedTableId, it, qty);
      success(`ƒê√£ th√™m ${qty} x ${it.name} v√†o B√†n ${selectedTableId}`);
    };
    menuItemsEl.appendChild(node);
  });
}

function renderTables(){
  tablesGridEl.innerHTML = '';
  state.tables.forEach(tb=>{
    const btn = document.createElement('div');
    btn.className = 'table-btn' + (selectedTableId===tb.id ? ' selected':'');
    // build inner html including note badge
    let noteBadge = '';
    if(tb.note && tb.note.trim().length>0){
      const short = tb.note.length>20 ? tb.note.slice(0,20)+'‚Ä¶' : tb.note;
      noteBadge = `<div class="note-badge" title="${escapeHtml(tb.note)}">üìù ${escapeHtml(short)}</div>`;
    }
    btn.innerHTML = `${noteBadge}<div style="font-weight:700">B√†n ${tb.id}</div>
                     <div class="table-status">${tb.currentOrder.length} m√≥n ‚Ä¢ ${fmtVND(calcOrderTotal(tb.currentOrder))}</div>`;
    btn.onclick = ()=>{
      selectedTableId = tb.id;
      renderAll();
      // focus note area
      setTimeout(()=>{ tableNoteEl.focus(); }, 30);
    };
    tablesGridEl.appendChild(btn);
  });
}

function renderOrderPanel(){
  if(selectedTableId===null){ orderPanel.style.display='none'; noTableSelected.style.display='block'; currentTableLabel.textContent='‚Äî'; return; }
  orderPanel.style.display='block'; noTableSelected.style.display='none';
  const tb = state.tables.find(t=>t.id===selectedTableId);
  currentTableLabel.textContent = 'B√†n ' + selectedTableId;
  tableInfoEl.textContent = `B√†n ${selectedTableId} ‚Ä¢ ${tb.currentOrder.length} m√≥n hi·ªán c√≥.`;
  // render order list
  orderListEl.innerHTML = '';
  tb.currentOrder.forEach((it, idx)=>{
    const row = document.createElement('div');
    row.className = 'order-row';
    row.innerHTML = `<div class="qty">${it.qty}</div>
                     <div class="name">${it.name}</div>
                     <div class="price">${fmtVND(it.price * it.qty)}</div>
                     <div style="display:flex;gap:6px">
                       <button class="btn ghost btn-dec">-</button>
                       <button class="btn ghost btn-inc">+</button>
                       <button class="btn danger btn-del">X√≥a</button>
                     </div>`;
    row.querySelector('.btn-inc').onclick = ()=>{
      it.qty++; saveAndRender();
    };
    row.querySelector('.btn-dec').onclick = ()=>{
      if(it.qty>1){ it.qty--; saveAndRender(); } else { if(confirm('X√≥a m√≥n n√†y?')){ tb.currentOrder.splice(idx,1); saveAndRender(); } }
    };
    row.querySelector('.btn-del').onclick = ()=>{
      if(confirm('X√≥a m√≥n?')){ tb.currentOrder.splice(idx,1); saveAndRender(); success('M√≥n ƒë√£ ƒë∆∞·ª£c x√≥a.'); }
    };
    orderListEl.appendChild(row);
  });
  tableTotalEl.textContent = fmtVND(calcOrderTotal(tb.currentOrder));
  renderRecentHistory(tb);
  // load note for this table
  tableNoteEl.value = tb.note || '';
  updateNoteMeta();
}

function renderRecentHistory(tb){
  recentHistoryEl.innerHTML = '';
  const last = tb.history.slice(-5).reverse();
  if(last.length===0){ recentHistoryEl.innerHTML = '<div class="small">Ch∆∞a c√≥ l·ªãch s·ª≠ thanh to√°n.</div>'; return; }
  last.forEach(h=>{
    const el = document.createElement('div');
    el.className = 'history-item';
    const date = new Date(h.timestamp).toLocaleString();
    el.innerHTML = `<div style="font-weight:700">${fmtVND(h.total)}</div>
                    <div class="small">${date}</div>
                    <div style="margin-top:6px" class="small">${h.items.map(i=> `${i.qty}x ${escapeHtml(i.name)}`).join(' ‚Ä¢ ')}</div>`;
    recentHistoryEl.appendChild(el);
  });
}

function renderTotalRevenue(){
  totalRevenueEl.textContent = fmtVND(state.totalRevenue);
  storageStateEl.textContent = state.storageEnabled ? 'ON' : 'OFF';
  toggleStorageBtn.textContent = state.storageEnabled ? 'T·∫Øt l∆∞u' : 'B·∫≠t l∆∞u';
}

function renderAll(){
  renderCategories();
  renderMenu();
  renderTables();
  renderOrderPanel();
  renderTotalRevenue();
}

// ======= Helpers =======
function escapeHtml(str){
  if(!str) return '';
  return String(str).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; });
}

// ======= Actions =======
function addItemToTable(tableId, menuItem, qty=1){
  const tb = state.tables.find(t=>t.id===tableId);
  if(!tb) return;
  // merge if same menuId exists
  const existing = tb.currentOrder.find(x => x.menuId === menuItem.id);
  if(existing){ existing.qty += qty; }
  else tb.currentOrder.push({menuId: menuItem.id, name: menuItem.name, price: menuItem.price, qty: qty});
  saveAndRender();
}

function addCustomItemToTable(tableId, name, price, qty=1){
  const tb = state.tables.find(t=>t.id===tableId);
  tb.currentOrder.push({menuId: null, name: name, price: Number(price), qty: qty});
  saveAndRender();
  success(`ƒê√£ th√™m ${qty} x ${name} v√†o B√†n ${tableId}`);
}

function calcOrderTotal(order){
  // price stored in "ngh√¨n", so sum is also in "ngh√¨n"
  return order.reduce((s,i)=>s + (Number(i.price) * Number(i.qty)), 0);
}

function checkoutTable(tableId){
  const tb = state.tables.find(t=>t.id===tableId);
  if(!tb || tb.currentOrder.length===0){ info('Kh√¥ng c√≥ m√≥n ƒë·ªÉ thanh to√°n.'); return; }
  const total = calcOrderTotal(tb.currentOrder);
  if(!confirm(`Thanh to√°n b√†n ${tableId} - t·ªïng ${fmtVND(total)}?`)) return;
  // push to history
  tb.history.push({timestamp:Date.now(), items: tb.currentOrder.map(i=>({...i})), total: total});
  state.totalRevenue += total; // total in "ngh√¨n"
  // clear current order
  tb.currentOrder = [];
  saveAndRender();
  success(`Thanh to√°n th√†nh c√¥ng B√†n ${tableId} ‚Ä¢ ${fmtVND(total)}`);
}

function clearCurrentOrder(tableId){
  const tb = state.tables.find(t=>t.id===tableId);
  if(!tb) return;
  if(confirm('X√°c nh·∫≠n x√≥a order hi·ªán t·∫°i?')){ tb.currentOrder = []; saveAndRender(); success('ƒê√£ x√≥a order hi·ªán t·∫°i.'); }
}

// Manage menu: add category or item
function openAddItemModal(prefillCategory){
  modalRoot.innerHTML = '';
  const modal = document.createElement('div'); modal.className='modal';
  modal.innerHTML = `<div class="box">
    <h3>Th√™m m√≥n m·ªõi</h3>
    <label>T√™n m√≥n <input id="newName" /></label>
    <label>Danh m·ª•c <input id="newCategory" /></label>
    <label>Gi√° (ngh√¨n) <input id="newPrice" type="number" min="0" /></label>
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
      <button class="btn ghost" id="cancelBtn">Hu·ª∑</button>
      <button class="btn primary" id="saveBtn">L∆∞u m√≥n</button>
    </div>
  </div>`;
  modalRoot.appendChild(modal);
  if(prefillCategory) modal.querySelector('#newCategory').value = prefillCategory;
  modal.querySelector('#cancelBtn').onclick = ()=>{ modalRoot.innerHTML=''; };
  modal.querySelector('#saveBtn').onclick = ()=>{
    const name = modal.querySelector('#newName').value.trim();
    const cat = modal.querySelector('#newCategory').value.trim() || 'Kh√°c';
    const price = Number(modal.querySelector('#newPrice').value) || 0;
    if(!name || price<=0){ error('Nh·∫≠p t√™n v√† gi√° >= 1 (ƒë∆°n v·ªã: ngh√¨n)'); return; }
    const item = {id: genId(), name, category:cat, price};
    state.menu.push(item);
    rebuildCategories();
    saveAndRender();
    modalRoot.innerHTML = '';
    success('ƒê√£ th√™m m√≥n m·ªõi.');
  };
}

function openManageMenuModal(){
  modalRoot.innerHTML = '';
  const modal = document.createElement('div'); modal.className='modal';
  modal.innerHTML = `<div class="box">
    <h3>Qu·∫£n l√Ω Menu</h3>
    <div style="max-height:320px;overflow:auto;border:1px solid #f0f0f0;padding:8px;border-radius:6px" id="manageList"></div>
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
      <button class="btn ghost" id="closeBtn">ƒê√≥ng</button>
      <button class="btn primary" id="addBtn">+ Th√™m m√≥n</button>
    </div>
  </div>`;
  modalRoot.appendChild(modal);
  modal.querySelector('#closeBtn').onclick = ()=> modalRoot.innerHTML = '';
  modal.querySelector('#addBtn').onclick = ()=> openAddItemModal();

  const list = modal.querySelector('#manageList');
  function renderManageList(){
    list.innerHTML = '';
    state.menu.forEach(it=>{
      const row = document.createElement('div');
      row.style.display='flex';row.style.justifyContent='space-between';row.style.alignItems='center';
      row.style.padding='6px';row.style.borderBottom='1px dashed #eee';
      row.innerHTML = `<div><strong>${escapeHtml(it.name)}</strong> <div class="small">${escapeHtml(it.category)}</div></div>
                       <div style="display:flex;gap:8px;align-items:center">
                         <div class="small">${fmtVND(it.price)}</div>
                         <button class="btn ghost btn-edit">S·ª≠a</button>
                         <button class="btn danger btn-del">X√≥a</button>
                       </div>`;
      row.querySelector('.btn-del').onclick = ()=>{
        if(confirm('X√≥a m√≥n kh·ªèi menu?')){ state.menu = state.menu.filter(x=>x.id!==it.id); rebuildCategories(); renderManageList(); renderAll(); saveAndRender(); success('ƒê√£ x√≥a m√≥n kh·ªèi menu.'); }
      };
      row.querySelector('.btn-edit').onclick = ()=>{
        const newName = prompt('T√™n m·ªõi', it.name) || it.name;
        const newCat = prompt('Danh m·ª•c', it.category) || it.category;
        const newPrice = Number(prompt('Gi√° (ngh√¨n)', it.price) || it.price);
        it.name = newName; it.category = newCat; it.price = newPrice;
        rebuildCategories(); renderManageList(); renderAll(); saveAndRender();
        success('C·∫≠p nh·∫≠t m√≥n th√†nh c√¥ng.');
      };
      list.appendChild(row);
    });
  }
  renderManageList();
}

// Save and re-render
function saveAndRender(){
  if(state.storageEnabled) saveState(state);
  renderAll();
}

// Toggle storage
function toggleStorage(){
  state.storageEnabled = !state.storageEnabled;
  if(state.storageEnabled){
    saveState(state);
    success('ƒê√£ b·∫≠t l∆∞u tr·∫°ng th√°i v√†o localStorage.');
  } else {
    localStorage.removeItem(STORAGE_KEY);
    info('ƒê√£ t·∫Øt l∆∞u tr·∫°ng th√°i (localStorage b·ªã xo√°).');
  }
  renderTotalRevenue();
}

// Table notes actions
function saveNoteForSelectedTable(){
  if(!selectedTableId){ info('Vui l√≤ng ch·ªçn b√†n ƒë·ªÉ l∆∞u ghi ch√∫.'); return; }
  const tb = state.tables.find(t=>t.id===selectedTableId);
  tb.note = tableNoteEl.value.trim();
  saveAndRender();
  // flash saved indicator
  noteSavedIndicator.style.display = 'inline-flex';
  setTimeout(()=>{ noteSavedIndicator.style.display = 'none'; }, 1800);
  success(`ƒê√£ l∆∞u ghi ch√∫ cho B√†n ${selectedTableId}.`);
}
function clearNoteForSelectedTable(){
  if(!selectedTableId){ info('Vui l√≤ng ch·ªçn b√†n ƒë·ªÉ x√≥a ghi ch√∫.'); return; }
  const tb = state.tables.find(t=>t.id===selectedTableId);
  if(!tb.note) { tableNoteEl.value=''; updateNoteMeta(); return; }
  if(confirm('X√≥a ghi ch√∫ cho b√†n n√†y?')){ tb.note=''; tableNoteEl.value=''; saveAndRender(); success('ƒê√£ x√≥a ghi ch√∫.'); }
}

// open modal for adding custom item to selected table
function openAddCustomModal(){
  if(!selectedTableId){ info('Ch·ªçn b√†n tr∆∞·ªõc.'); return; }
  modalRoot.innerHTML = '';
  const md = document.createElement('div'); md.className='modal';
  md.innerHTML = `<div class="box">
    <h3>Th√™m m√≥n tu·ª≥ √Ω cho B√†n ${selectedTableId}</h3>
    <label>T√™n m√≥n <input id="custName" /></label>
    <label>Gi√° (ngh√¨n) <input id="custPrice" type="number" /></label>
    <label>S·ªë l∆∞·ª£ng <input id="custQty" type="number" value="1" min="1" /></label>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn ghost" id="cCancel">Hu·ª∑</button>
      <button class="btn primary" id="cSave">Th√™m</button>
    </div>
  </div>`;
  modalRoot.appendChild(md);
  md.querySelector('#cCancel').onclick = ()=> modalRoot.innerHTML='';
  md.querySelector('#cSave').onclick = ()=>{
    const name = md.querySelector('#custName').value.trim();
    const price = Number(md.querySelector('#custPrice').value) || 0;
    const qty = Number(md.querySelector('#custQty').value) || 1;
    if(!name || price<=0){ error('Nh·∫≠p t√™n v√† gi√° h·ª£p l·ªá.'); return; }
    addCustomItemToTable(selectedTableId, name, price, qty);
    modalRoot.innerHTML = '';
  };
}

// View full history modal for table
function openHistoryModal(tb){
  modalRoot.innerHTML='';
  const md = document.createElement('div'); md.className='modal';
  let html = `<div class="box"><h3>L·ªãch s·ª≠ B√†n ${tb.id}</h3>`;
  if(tb.history.length===0){ html += `<div class="small">Ch∆∞a c√≥ l·ªãch s·ª≠</div>`; }
  else{
    html += `<div style="max-height:360px;overflow:auto">`;
    tb.history.slice().reverse().forEach(h=>{
      html += `<div style="padding:10px;border:1px solid #f0f0f0;border-radius:6px;margin-bottom:8px">
        <div style="display:flex;justify-content:space-between"><div><strong>${fmtVND(h.total)}</strong></div><div class="small">${new Date(h.timestamp).toLocaleString()}</div></div>
        <div class="small" style="margin-top:6px">${h.items.map(it=>`${it.qty}x ${escapeHtml(it.name)}`).join(' ‚Ä¢ ')}</div>
      </div>`;
    });
    html += `</div>`;
  }
  html += `<div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
    <button class="btn ghost" id="closeHis">ƒê√≥ng</button>
  </div></div>`;
  md.innerHTML = html;
  modalRoot.appendChild(md);
  md.querySelector('#closeHis').onclick = ()=> modalRoot.innerHTML='';
}

// ======= Event bindings =======
searchInput.addEventListener('input', e=>{
  menuFilter = e.target.value;
  renderMenu();
});
toggleStorageBtn.onclick = ()=>{ toggleStorage(); renderTotalRevenue(); };
openAddItemBtn.onclick = ()=> openAddItemModal();
openManageMenuBtn.onclick = ()=> openManageMenuModal();
checkoutBtn.onclick = ()=> { if(selectedTableId) checkoutTable(selectedTableId); };
clearOrderBtn.onclick = ()=> { if(selectedTableId) clearCurrentOrder(selectedTableId); };
viewHistoryBtn.onclick = ()=> { if(selectedTableId) openHistoryModal(state.tables.find(t=>t.id===selectedTableId)); };
addCustomToTableBtn.onclick = ()=> openAddCustomModal();
saveNoteBtn.onclick = ()=> saveNoteForSelectedTable();
clearNoteBtn.onclick = ()=> clearNoteForSelectedTable();

tableNoteEl.addEventListener('input', ()=> updateNoteMeta());

function updateNoteMeta(){
  const len = (tableNoteEl.value || '').length;
  noteCharCount.textContent = `${len} k√Ω t·ª±`;
  // show unsaved state by briefly showing nothing or hiding saved indicator
  noteSavedIndicator.style.display = 'none';
}

// keyboard quick-add: press number 1-9 to select table (also allow 0 for 10, etc)
document.addEventListener('keydown', (e)=>{
  if(e.key >= '1' && e.key <= '9'){ const num=Number(e.key); if(num<=17){ selectedTableId = num; renderAll(); } }
  if(e.key === '0'){ selectedTableId = 10; renderAll(); }
});

// initial render
renderAll();

</script>
</body>
</html>
